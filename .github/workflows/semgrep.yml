name: "🔍 Semgrep OWASP Scan (no external token)"

on:
  push:
    branches:
      - main
  schedule:
      - cron: '0 * * * *'
  pull_request:
    branches:
      - main

jobs:
  semgrep:
    name: Semgrep OWASP
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout del codice
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Esegui Semgrep con le regole OWASP Top 10
      - name: Run Semgrep OWASP Top 10
        uses: returntocorp/semgrep-action@v0.57.0
        with:
          semgrep_args: --config p/owasp-top-10
        env:
          # permette a Semgrep Action di postare commenti nelle PR
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      # 3. (Opzionale) Esporta in SARIF e integra con GitHub Code Scanning
      - name: Export SARIF report
        if: always()
        run: semgrep --config p/owasp-top-10 --sarif > semgrep.sarif

      - name: Upload SARIF to GitHub
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif