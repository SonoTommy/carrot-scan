name: Automated Ollama Code Review & Fix

# ▶️ Quando si attiva
on:
  schedule:
    - cron: '0 * * * *'
  pull_request:
    branches: [ main ]   # si lancia su ogni PR verso main
  workflow_dispatch:      # si può avviare a mano dal tab Actions

# ▶️ Permessi minimi per committare e aprire PR
permissions:
  contents: write
  pull-requests: write

jobs:
  ollama_review_apply:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      # 2. Installa Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama --version

      # 3. Pre-scarica il modello (facoltativo ma più veloce)
      - name: Pull model
        run: ollama pull deepseek-r1:1.5b

      # 4. Ottieni il diff della PR
      - name: Collect diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Prova a prendere il diff dalla pull‑request se esiste
          echo "🔎 Attempting gh pr diff for ref ${GITHUB_REF##*/}"
          if gh pr diff "${GITHUB_REF##*/}" > pr.diff 2>/dev/null; then
            echo "✅ PR diff collected"
          else
            echo "ℹ️  No pull‑request found for branch ${GITHUB_REF##*/}; falling back to git diff against origin/main"
            git fetch origin main
            git diff origin/main...HEAD > pr.diff
          fi

          # Se il diff è vuoto, segnalo con un marker
          if [ ! -s pr.diff ]; then
            echo "⚠️  Diff is empty" && touch pr_empty
          fi

      # 5. Chiedi a Ollama di produrre una patch
      - name: Ask Ollama to propose a patch
        id: genpatch
        run: |
          BASE_PROMPT=$'Agisci come maintainer open‑source esperto.\nSuggerisci miglioramenti a codice e documentazione (refactor, bug‑fix, README, commenti).\nRispondi **solo** con un diff unificato applicabile via `git apply`, senza testo extra.\nAssicurati che inizi con `diff --git`.\n\n'

          # Se non abbiamo un diff di partenza, passiamo la lista file
          if [ -f pr_empty ]; then
            echo "⚠️  Nessun diff di partenza: passo a Ollama la lista dei file"
            REPO_FILES=$(git ls-files | head -n 200)             # limitiamo a 200 file
            FINAL_PROMPT="${BASE_PROMPT}Ecco i file attuali del repo:\n${REPO_FILES}"
            ollama run deepseek-r1:1.5b "$FINAL_PROMPT" > ollama.patch || true
          else
            DIFF_CONTENT=$(cat pr.diff)
            FINAL_PROMPT="${BASE_PROMPT}Ecco il diff corrente:\n${DIFF_CONTENT}"
            ollama run deepseek-r1:1.5b "$FINAL_PROMPT" > ollama.patch || true
          fi

          # Flagga se Ollama ha generato un vero diff
          if grep -q "^diff --git" ollama.patch; then
            echo "has_patch=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_patch=false" >> "$GITHUB_OUTPUT"
          fi

      # 6. Applica la patch e pusha un branch
      - name: Apply patch & push branch
        if: steps.genpatch.outputs.has_patch == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git apply ollama.patch
          git config user.name "ollama-bot"
          git config user.email "ollama-bot@users.noreply.github.com"
          git add -A
          git commit -m "chore(ollama): AI fixes & docs"
          BRANCH="ollama-fix-${{ github.run_id }}"
          git switch -c "$BRANCH"
          git push -u origin "$BRANCH"

      # 7. Crea la pull-request con i miglioramenti
      - name: Open PR with Ollama improvements
        if: steps.genpatch.outputs.has_patch == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          branch: ollama-fix-${{ github.run_id }}
          title: "🤖 Ollama automated improvements"
          body: |
            Patch generata da **deepseek-r1:1.5b**.
            Contiene bug-fix, refactor e miglioramenti di documentazione.
          labels: ai, ollama