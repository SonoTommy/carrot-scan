name: Automated Ollama Code Review & Fix

# â–¶ï¸ Quando si attiva
on:
  pull_request:
    branches: [ main ]   # si lancia su ogni PR verso main
  workflow_dispatch:      # si puÃ² avviare a mano dal tab Actions

# â–¶ï¸ Permessi minimi per committare e aprire PR
permissions:
  contents: write
  pull-requests: write

jobs:
  ollama_review_apply:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      # 2. Installa Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama --version

      # 3. Pre-scarica il modello (facoltativo ma piÃ¹ veloce)
      - name: Pull model
        run: ollama pull deepseek-r1:1.5b

      # 4. Ottieni il diff della PR
      - name: Collect diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Se il workflow nasce da una pull-request â†’ usa gh pr diff
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            echo "ðŸ”Ž Gathering diff for PR #${GITHUB_REF##*/}"
            gh pr diff "${GITHUB_REF##*/}" > pr.diff

          # Se parte da workflow_dispatch â†’ diff fra HEAD e origin/main
          else
            echo "ðŸ”Ž No PR context; diff HEAD vs origin/main"
            git fetch origin main
            git diff origin/main...HEAD > pr.diff
          fi

          # Se il diff Ã¨ vuoto, segnalo con un marker
          if [ ! -s pr.diff ]; then
            echo "âš ï¸  Diff is empty" && touch pr_empty
          fi

      # 5. Chiedi a Ollama di produrre una patch
      - name: Ask Ollama to propose a patch
        id: genpatch
        
        run: |
          PROMPT=$'Agisci come maintainer open-source esperto.\nSuggerisci miglioramenti a codice e documentazione.\nRispondi **solo** con un diff unificato applicabile via `git apply`, senza testo extra.'
          cat pr.diff | ollama run deepseek-r1:1.5b -p "$PROMPT" > ollama.patch || true

          # Flagga se ha generato un vero diff
          if grep -q "^diff --git" ollama.patch; then
            echo "has_patch=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_patch=false" >> "$GITHUB_OUTPUT"
          fi

      # 6. Applica la patch e pusha un branch
      - name: Apply patch & push branch
        if: steps.genpatch.outputs.has_patch == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git apply ollama.patch
          git config user.name "ollama-bot"
          git config user.email "ollama-bot@users.noreply.github.com"
          git add -A
          git commit -m "chore(ollama): AI fixes & docs"
          BRANCH="ollama-fix-${{ github.run_id }}"
          git switch -c "$BRANCH"
          git push -u origin "$BRANCH"

      # 7. Crea la pull-request con i miglioramenti
      - name: Open PR with Ollama improvements
        if: steps.genpatch.outputs.has_patch == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_PAT }}
          branch: ollama-fix-${{ github.run_id }}
          title: "ðŸ¤– Ollama automated improvements"
          body: |
            Patch generata da **deepseek-r1:1.5b**.
            Contiene bug-fix, refactor e miglioramenti di documentazione.
          labels: ai, ollama